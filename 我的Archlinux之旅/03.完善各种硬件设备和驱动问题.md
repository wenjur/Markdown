# 完善各种硬件设备和驱动问题

那前面安装完arch后，界面是相当丑的，而且各种硬件设备包括键盘、鼠标、显卡、电池等的管理工具或驱动都没有。因此这里参考着archwiki和网上教程再进一步完善arch。

主要内容有[Bluetooth](#Bluetooth)，[CPU](#CPU)，[显示](#显示)

[TOC]

## Bluetooth

参考：[Bluetooth - ArchWiki](https://wiki.archlinux.org/title/Bluetooth)

#### 安装

需要安装用蓝牙协议栈和管理工具，驱动默认是已经安装了的（即`btusb`）。

```
# pacman -S bluez bluez-utils				-- 安装蓝牙协议栈和管理工具
# systemctl start bluetooth.service
# systemctl enable bluetooth.service
# pacman -S bluedevil						-- kde图形化蓝牙管理工具，默认安装plasma时已包含
```

蓝牙管理工具还有`blueman`可选，功能较为全面。[Blueman - ArchWiki](https://wiki.archlinux.org/title/Blueman)

#### 双系统配对（未做）

之前电脑里装windows和centos双系统时，出现过一个问题：我的键盘型号是罗技k380，最大支持三个配对设备。win配对1端口，centos配对2端口。我在win下配对端口1后可以正常使用。切换到centos后，再次配对到2端口后也可以正常使用。但是问题在于，当我再次切换回win时，键盘也切换为1端口，却发现键盘怎么也连接不上win了，这个时候需要重新配对才能正常使用。同样地，再次回到centos也需要重新配对。

那么wiki这里给出了解决方案，虽然看起来有点麻烦。简单解释起来就是，蓝牙设备分别与linux和windows配对后，各自都会产生一份配置文件，需要将linux的配置文件中的某些值手动修改，保持与windows的相同即可。

我需要的配对的蓝牙设备是罗技K380。

首先，先在arch下配对键盘，然后重启回到windows再次与键盘配对。再次重启回到arch，挂载windows系统盘。

```
# pacman -S ntfs-3g	chntpw		-- 挂载windows的ntfs盘，需要ntfs-3g的支持。chntpw用于在windows中获取配对设备的'key'
# lsblk							-- 查看windows的分区，确定分区设备名
# mount /dev/nmve0n1p3 /mnt		-- /dev/nvme0n1p3是我的windows系统盘，即c盘。
# cd /mnt/Windows/System32/config
# chntpw -e SYSTEM				-- 此时进入了chntpw环境
> cd ContrloSet001\Services\BTHPORT\Parameters\Keys
> ls							-- 列出电脑的蓝牙mac地址,形式为 <num>
Node has 1 subkeys and 0 values
> cd num						-- 把<>去掉
> ls
Node has 0 subkeys and 2 values	-- 已经配对了几个蓝牙设备就会存在多少values
size	type		value 	name		[value if type DWORD]
16		REG_BINARY	<num1>
16		REG_BINATY	<num2>
> hex num1			-- 获取设备的key，num1是前面的value值
:00000 XX XX XX XX XX XX XX XX XX XX XX XX XX XX XX XX ...(其他字母)	-- XX XX ...就是num1的配对key．
> hex num2
:00000 XX XX XX XX XX XX XX XX XX XX XX XX XX XX XX XX ...(其他字母)	-- 得到num2的配对key
```

拿小本本把两个key记下来，注意其分别对应的value。这两个value其实是配对设备的MAC地址（手机和键盘）。

```
# cd /var/lib/bluetooth/BT-Adapter-MAC-addr		-- BT-Adapter-MAC-addr是本电脑的蓝牙mac地址
# ls -l											-- 同样地我这里有两个device-MAC-addr
# cd device-MAC-addr							-- device-MAC-addr建议tab键补全输入。
# vim info										-- 编辑配置文件
```

找到如下位置：

> [LinkKey]
> Key=XXXXXXXXXXXXXXXX

替换Key即可。注意一定要大写，不能有空格。

对其他所有的device-MAC-addr里的info文件更新Key。

#### 蓝牙音频（未做）

想使用蓝牙耳机的话，就需要安装这个pulseaudio。该包实际上是提供了蓝牙音频的功能。

```
# pacman -S pulseaudio-bluetooth
```

#### 

#### 省电（未做）



## CPU

参考：[CPU frequency scaling - ArchWiki](https://wiki.archlinux.org/title/CPU_frequency_scaling)，[Fan speed control - ArchWiki](https://wiki.archlinux.org/title/Fan_speed_control)

#### cpu调频（虚拟机）

调频需要驱动支持，kernel目前包含`intel_pstate`驱动，且默认开启。也可以选择加载`acpi-cpufreq`

```
[root@ArchLinuxf ~]# modprobe acpi-cpufreq
```

Q：modprobe: ERROR: could not insert 'acpi-cpufreq': No such device

A：暂时不清楚什么原因。猜测可能是虚拟机的问题。

```
[root@ArchLinuxf ~]# pacman -S cpupower		-- 安装cpupower包
```

cpupower用户工具集可以手动进行cpu调频，推荐安装。

查看cpu信息

```
[root@ArchLinuxf ~]# cpupower frequency-info
```

Q：输出中有一行：no or unknown cpufreq driver is active on this CPU

A：显然acpi-cpufreq加载失败，而且在/sys/devices/system/cpu下也没有intel_pstate目录，大概率`intel_pstate`也没有启用

#### cpu调频（物理机）

都已自动设置完毕。

#### 风扇（未做）

...（挖坑）

## 显示

参考：[Intel graphics - ArchWiki](https://wiki.archlinux.org/title/Intel_graphics)

我的电脑显卡型号是Intel UHD Graphics 620和AMD(TM) RX550，我只对集显做适配。

```
[root@ArchLinuxf ~]# pacman -S vulkan-intel mesa		-- mesa提供3D加速
```

加载模块`modesetting`提供2D加速。

...

#### KMS（未做）

参考：[Kernel mode setting - ArchWiki](https://wiki.archlinux.org/title/Kernel_mode_setting)

KMS是解决什么问题的？

终端(tty)的显示效果比较差，不比桌面环境。同时，桌面环境和tty之间相互切换时，显卡的控制会由x server移交给kernel，由于分辨率的差别，这个过程比较慢并且还会闪屏。那KMS就允许kernel修改显卡的相关设置，做到开机后终端界面立刻就可以拥有一个不错的显示效果。

经过实际测试，我的物理机tty和桌面环境切换时没有问题。以防bug，这一部分就暂时不设置了。

#### 硬件视频加速

参考：[Hardware_video_acceleration - ArchWiki](https://wiki.archlinux.org/title/Hardware_video_acceleration)

让显卡进行视频的解码、编码。减轻cpu的负载并省电。主要有两种开源API库：VA-API和VDPAU，分别由intel和英伟达开发。

调用API加速视频需要驱动支持。Intel HD Graphics（集成于intel core 8th）的驱动由`intel-media-driver`提供。下载：

```
# pacman -S intel-media-driver
```

注意：amd、nvidia都有对应的VA-API和VDPAU驱动，而intel只有VA-API驱动，没有VDPAU驱动。因此，为了使intel集显支持VDPAU，还需安装libvdpau-va-gl包（VDPAU驱动，但是底层调用VA-API，也就是曲线救国）。

```
# pacman -S libvdpau-va-gl
```

再安装`libva-utils`和`vdpauinfo`两个包。

```
# pacman -S libva-utils vdpauinfo		-- 提供验证所用工具
```

验证：一般情况下，安装完`intel-media-driver`和`libvdpau-va-gl`两个包之后，视频加速就已经可用了。执行vainfo检查VA-API，执行vdpauinfo检查VDPAU。

```
# vainfo
...
# vdpauinfo
...
```

根据输出结果可以查看受支持的视频编码格式。

Q：vainfo验证没有问题。vdpauinfo在普通用户下执行也有正确的输出结果，然而root用户下，报错：cannot connect to X server.

A：原因未知。

